<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROBOT CONTROL V.FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --bg-dark: #0b0c15;
            --panel-bg: rgba(20, 25, 40, 0.9);
            --text-main: #ffffff;
        }

        body {
            margin: 0; padding: 20px;
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }

        /* Header */
        header {
            width: 100%; max-width: 600px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        h1 { margin: 0; font-family: 'Orbitron'; font-size: 1.5rem; }
        .btn-logout {
            background: none; border: 1px solid var(--secondary); color: var(--secondary);
            padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        /* Status Cards */
        .dashboard {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            width: 100%; max-width: 600px; margin-bottom: 20px;
        }
        .card {
            background: var(--panel-bg); padding: 15px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .card i { font-size: 1.8rem; margin-bottom: 5px; color: #888; }
        .label { font-size: 0.8rem; opacity: 0.7; }
        .value { font-size: 1.2rem; font-family: 'Orbitron'; font-weight: bold; margin-top: 5px; }

        /* Colors */
        .on { color: #00ff88; text-shadow: 0 0 5px #00ff88; }
        .off { color: #ff3333; text-shadow: 0 0 5px #ff3333; }
        .wait { color: #ffaa00; }

        /* Control Buttons */
        .controls {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            width: 100%; max-width: 600px; margin-bottom: 20px;
        }
        .btn {
            background: linear-gradient(145deg, #1e2330, #161a25);
            border: 1px solid #444; color: white;
            padding: 20px 0; border-radius: 10px;
            font-family: 'Orbitron'; font-size: 1rem; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .btn:active { background: var(--primary); color: black; }
        .btn-home { grid-column: span 3; background: linear-gradient(90deg, #cc0044, #ff0055); border: none; }

        /* System Log */
        .log-container {
            width: 100%; max-width: 600px;
            height: 150px;
            background: #000; border: 1px solid #333; border-radius: 10px;
            padding: 10px; overflow-y: auto;
            font-family: monospace; font-size: 0.85rem; color: #0f0;
            box-sizing: border-box;
        }
        .log-entry { border-bottom: 1px solid #111; padding: 2px 0; }
        .time { color: #666; margin-right: 5px; }

        /* Login Modal */
        #login-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box { text-align: center; width: 300px; }
        .inp { width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; text-align: center; }
        .btn-login { width: 100%; padding: 10px; background: var(--primary); border: none; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="color:var(--primary); font-family:'Orbitron'">SYSTEM LOGIN</h2>
            <input type="text" id="user" class="inp" placeholder="Username">
            <input type="password" id="pass" class="inp" placeholder="Password">
            <button class="btn-login" onclick="login()">ACCESS</button>
            <p id="msg" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app" style="display:none; width:100%; flex-direction:column; align-items:center;">
        
        <header>
            <h1>ROBOT<span style="color:var(--primary)">CONTROLLER</span></h1>
            <button class="btn-logout" onclick="logout()">LOGOUT</button>
        </header>

        <div class="dashboard">
            <div class="card">
                <i class="fas fa-wifi" id="icon-net"></i>
                <span class="label">CONNECTION</span>
                <span class="value off" id="txt-net">OFFLINE</span>
            </div>
            <div class="card">
                <i class="fas fa-box" id="icon-cargo"></i>
                <span class="label">CARGO STATUS</span>
                <span class="value" id="txt-cargo" style="color:#888">UNKNOWN</span>
            </div>
            <div class="card">
                <i class="fas fa-robot" id="icon-bot"></i>
                <span class="label">ROBOT STATE</span>
                <span class="value" id="txt-status">IDLE</span>
            </div>
            <div class="card">
                <i class="fas fa-ruler-horizontal"></i>
                <span class="label">DISTANCE</span>
                <span class="value" id="txt-dist">-- cm</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="send('room1')"><i class="fas fa-map-marker-alt"></i>ROOM 1</button>
            <button class="btn" onclick="send('room2')"><i class="fas fa-map-marker-alt"></i>ROOM 2</button>
            <button class="btn" onclick="send('room3')"><i class="fas fa-map-marker-alt"></i>ROOM 3</button>
            <button class="btn btn-home" onclick="send('return')"><i class="fas fa-home"></i>RETURN TO BASE</button>
        </div>

        <div class="log-container" id="log-box">
            <div class="log-entry">--- SYSTEM READY ---</div>
        </div>

    </div>

    <script>
        // --- 1. CONFIGURATION (ต้องตรงกับ Arduino) ---
        const MQTT_HOST = "broker.hivemq.com";
        const MQTT_PORT = 8884; // Web ต้องใช้ 8884 (Secure)
        const TOPIC_CMD = "myrobot/command";
        const TOPIC_STATUS = "myrobot/status";
        
        // Login Credentials
        const USER_SET = "admin";
        const PASS_SET = "1234";

        var client = null;

        // --- 2. LOGIN SYSTEM ---
        if(localStorage.getItem("isLogged") === "true") {
            showApp();
        }

        function login() {
            let u = document.getElementById("user").value;
            let p = document.getElementById("pass").value;
            if(u === USER_SET && p === PASS_SET) {
                localStorage.setItem("isLogged", "true");
                showApp();
            } else {
                document.getElementById("msg").innerText = "Wrong Password!";
            }
        }

        function logout() {
            if(client) { try { client.disconnect(); } catch(e){} }
            localStorage.removeItem("isLogged");
            location.reload();
        }

        function showApp() {
            document.getElementById("login-modal").style.display = "none";
            document.getElementById("app").style.display = "flex";
            initMQTT(); // เริ่มเชื่อมต่อเมื่อ Login ผ่าน
        }

        // --- 3. MQTT CONNECTION ---
        function initMQTT() {
            const clientID = "web_" + parseInt(Math.random() * 100000);
            client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, clientID);

            client.onConnectionLost = onLost;
            client.onMessageArrived = onMessage;

            connect();
        }

        function connect() {
            log("Connecting to Broker...");
            document.getElementById("txt-net").innerText = "CONNECTING...";
            document.getElementById("txt-net").className = "value wait";

            client.connect({
                onSuccess: onConnect,
                onFailure: onFail,
                useSSL: true, // สำคัญมากสำหรับ GitHub Pages
                timeout: 5,
                keepAliveInterval: 30
            });
        }

        function onConnect() {
            log("CONNECTED: " + MQTT_HOST);
            document.getElementById("txt-net").innerText = "ONLINE";
            document.getElementById("txt-net").className = "value on";
            document.getElementById("icon-net").className = "fas fa-wifi on";
            
            client.subscribe(TOPIC_STATUS);
            log("Subscribed: " + TOPIC_STATUS);
        }

        function onFail(e) {
            log("Connect Failed: " + e.errorMessage);
            document.getElementById("txt-net").innerText = "RETRYING...";
            document.getElementById("txt-net").className = "value off";
            setTimeout(connect, 5000);
        }

        function onLost(e) {
            if(e.errorCode !== 0) {
                log("Connection Lost: " + e.errorMessage);
                document.getElementById("txt-net").innerText = "OFFLINE";
                document.getElementById("txt-net").className = "value off";
                document.getElementById("icon-net").className = "fas fa-wifi off";
                setTimeout(connect, 3000);
            }
        }

        // --- 4. SEND & RECEIVE ---
        function send(cmd) {
            if(client && client.isConnected()) {
                let payload = JSON.stringify({ "cmd": cmd });
                let message = new Paho.MQTT.Message(payload);
                message.destinationName = TOPIC_CMD;
                client.send(message);
                log("Sent Command: " + cmd);
            } else {
                alert("Offline! Cannot send command.");
            }
        }

        function onMessage(msg) {
            try {
                // Arduino ส่งมาแบบนี้: {"cargo":bool, "distance":int, "status":str, "room":int}
                const data = JSON.parse(msg.payloadString);
                
                // Update UI - Cargo
                const elCargo = document.getElementById("txt-cargo");
                const icCargo = document.getElementById("icon-cargo");
                if(data.cargo) {
                    elCargo.innerText = "LOADED"; elCargo.className = "value on";
                    icCargo.style.color = "#00ff88";
                } else {
                    elCargo.innerText = "EMPTY"; elCargo.className = "value";
                    icCargo.style.color = "#888";
                }

                // Update UI - Status
                const elStat = document.getElementById("txt-status");
                const icBot = document.getElementById("icon-bot");
                if(data.status === "delivering") {
                    elStat.innerText = "RUNNING (Room " + data.room + ")";
                    elStat.className = "value on";
                    icBot.className = "fas fa-robot on";
                } else {
                    elStat.innerText = "IDLE / READY";
                    elStat.className = "value";
                    icBot.className = "fas fa-robot";
                }

                // Update UI - Distance
                document.getElementById("txt-dist").innerText = data.distance + " cm";

                // Log (แบบสั้นๆ)
                // log(`Status:${data.status} | Dist:${data.distance}`);

            } catch(e) {
                console.log("JSON Error: " + e);
            }
        }

        function log(msg) {
            const box = document.getElementById("log-box");
            const time = new Date().toLocaleTimeString('en-GB');
            box.innerHTML += `<div class="log-entry"><span class="time">[${time}]</span>${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

    </script>
</body>
</html>
