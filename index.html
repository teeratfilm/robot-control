<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGV SYSTEM MONITOR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --text-main: #c9d1d9;
            --accent-green: #2ea043;
            --accent-red: #da3633;
            --accent-blue: #58a6ff;
            --border: #30363d;
        }

        body {
            margin: 0; padding: 20px;
            font-family: 'JetBrains Mono', monospace; /* ฟอนต์แบบ Terminal */
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            box-sizing: border-box;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* --- Header --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        h1 { margin: 0; font-size: 1.5rem; color: var(--accent-blue); }

        /* --- Status Grid --- */
        .status-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
        }

        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            padding: 15px; border-radius: 6px;
        }

        .label { font-size: 0.8rem; color: #8b949e; display: block; margin-bottom: 5px; }
        .value { font-size: 1.2rem; font-weight: bold; }
        
        .val-green { color: var(--accent-green); }
        .val-red { color: var(--accent-red); }
        .val-blue { color: var(--accent-blue); }

        /* --- Control Buttons --- */
        .controls {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        
        button {
            background: #21262d; border: 1px solid var(--border);
            color: var(--text-main); padding: 15px 0;
            font-family: inherit; font-weight: bold; cursor: pointer;
            border-radius: 6px; transition: 0.2s;
        }
        button:hover { background: #30363d; border-color: #8b949e; }
        button:active { background: #161b22; }

        .btn-return { background: rgba(218, 54, 51, 0.1); border-color: var(--accent-red); color: var(--accent-red); }
        .btn-return:hover { background: rgba(218, 54, 51, 0.2); }

        /* --- LOG CONSOLE (พระเอกของงานนี้) --- */
        .log-container {
            flex-grow: 1; /* ยืดเต็มพื้นที่ที่เหลือ */
            background: #000;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            overflow-y: auto; /* เลื่อนขึ้นลงได้ */
            font-size: 0.9rem;
            display: flex; flex-direction: column;
        }
        
        .log-header {
            border-bottom: 1px solid #333; margin-bottom: 10px; padding-bottom: 5px;
            font-weight: bold; color: #8b949e;
        }

        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px;}
        .time { color: #8b949e; margin-right: 10px; }
        .log-info { color: var(--text-main); }
        .log-warn { color: #d29922; }
        .log-success { color: var(--accent-green); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }

    </style>
</head>
<body>

    <header>
        <h1>AGV MONITOR [TEXT MODE]</h1>
        <div id="net-status" class="val-red">OFFLINE</div>
    </header>

    <div class="status-grid">
        <div class="card">
            <span class="label">CURRENT STATE</span>
            <span class="value val-blue" id="disp-state">WAITING...</span>
        </div>
        <div class="card">
            <span class="label">TARGET ROOM</span>
            <span class="value" id="disp-room">-</span>
        </div>
        <div class="card">
            <span class="label">CARGO STATUS</span>
            <span class="value" id="disp-cargo">UNKNOWN</span>
        </div>
        <div class="card">
            <span class="label">DISTANCE SENSOR</span>
            <span class="value" id="disp-dist">-- cm</span>
        </div>
    </div>

    <div class="controls">
        <button onclick="sendCmd('room1')">[ ROOM 1 ]</button>
        <button onclick="sendCmd('room2')">[ ROOM 2 ]</button>
        <button onclick="sendCmd('room3')">[ ROOM 3 ]</button>
        <button class="btn-return" onclick="sendCmd('return')">[ < RETURN ]</button>
    </div>

    <div class="log-container" id="log-box">
        <div class="log-header">> SYSTEM LOG OUTPUT...</div>
        </div>

    <script>
        // --- Configuration ---
        const MQTT_HOST = "broker.hivemq.com";
        const MQTT_PORT = 8884;
        const TOPIC_CMD = "myrobot/command";
        const TOPIC_STATUS = "myrobot/status";
        const CLIENT_ID = "monitor_" + new Date().getTime();

        client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, CLIENT_ID);
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // Auto Connect
        connect();

        function connect() {
            addLog("Attempting to connect to Server...", "info");
            document.getElementById("net-status").innerText = "CONNECTING...";
            document.getElementById("net-status").className = "log-warn";
            
            client.connect({
                onSuccess: onConnect,
                onFailure: onFail,
                useSSL: true,
                timeout: 5,
                keepAliveInterval: 15
            });
        }

        function onConnect() {
            addLog("CONNECTED to HiveMQ Broker!", "success");
            document.getElementById("net-status").innerText = "ONLINE (SECURE)";
            document.getElementById("net-status").className = "val-green";
            client.subscribe(TOPIC_STATUS);
            addLog("Subscribed to topic: " + TOPIC_STATUS, "info");
        }

        function onFail(e) {
            addLog("Connection Failed: " + e.errorMessage, "warn");
            document.getElementById("net-status").innerText = "ERROR";
            document.getElementById("net-status").className = "val-red";
            setTimeout(connect, 3000);
        }

        function onConnectionLost(e) {
            if(e.errorCode !== 0) {
                addLog("Connection Lost: " + e.errorMessage, "warn");
                document.getElementById("net-status").innerText = "OFFLINE";
                document.getElementById("net-status").className = "val-red";
                setTimeout(connect, 3000);
            }
        }

        // --- รับข้อมูลจากหุ่นยนต์ ---
        function onMessageArrived(msg) {
            try {
                const payload = msg.payloadString;
                const data = JSON.parse(payload);
                
                // 1. อัปเดตหน้าจอหลัก (Dashboard)
                document.getElementById("disp-state").innerText = data.status.toUpperCase();
                document.getElementById("disp-room").innerText = (data.room === 0) ? "BASE" : "ROOM " + data.room;
                
                const dist = data.distance;
                document.getElementById("disp-dist").innerText = (dist > 500) ? "> 50cm" : dist + " cm";

                const cargoEl = document.getElementById("disp-cargo");
                if(data.cargo) {
                    cargoEl.innerText = "LOADED (HAS OBJECT)";
                    cargoEl.className = "value val-green";
                } else {
                    cargoEl.innerText = "EMPTY (NO OBJECT)";
                    cargoEl.className = "value val-red";
                }

                // 2. เขียนลง Log (รายงานละเอียด)
                // เราจะไม่เขียนทุกครั้งถ้าข้อมูลเดิมซ้ำๆ เพื่อไม่ให้รก
                // แต่ถ้าอยากเห็นทุกวินาที ให้เอา if ออกได้
                addLog(`RECV: Stat=${data.status} | Dist=${dist}cm | Cargo=${data.cargo}`, "info");

            } catch(e) {
                addLog("JSON Parse Error: " + e.message, "warn");
            }
        }

        // --- ส่งคำสั่ง ---
        function sendCmd(cmd) {
            if(client.isConnected()) {
                const message = new Paho.MQTT.Message(JSON.stringify({ "cmd": cmd }));
                message.destinationName = TOPIC_CMD;
                client.send(message);
                addLog(">> COMMAND SENT: " + cmd.toUpperCase(), "success");
            } else {
                addLog("Cannot send: Offline", "warn");
                alert("OFFLINE");
            }
        }

        // --- ระบบ Log ---
        function addLog(text, type) {
            const box = document.getElementById("log-box");
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            
            let colorClass = "log-info";
            if(type === "warn") colorClass = "log-warn";
            if(type === "success") colorClass = "log-success";

            const html = `
                <div class="log-entry">
                    <span class="time">[${time}]</span>
                    <span class="${colorClass}">${text}</span>
                </div>
            `;
            
            box.insertAdjacentHTML('beforeend', html);
            
            // Auto Scroll ลงล่างสุด
            box.scrollTop = box.scrollHeight;
        }

    </script>
</body>
</html>
