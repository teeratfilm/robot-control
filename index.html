<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliBot Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --bg-dark: #0b0c15;
            --panel-bg: rgba(20, 25, 40, 0.9);
            --text-main: #ffffff;
            --road-color: #2c3e50;
        }

        body {
            margin: 0; padding: 20px;
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 10%, #1a1a2e 0%, #000 100%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }

        /* --- 1. Animation Scene (ส่วนแสดงผลการ์ตูน) --- */
        .scene-container {
            width: 100%; max-width: 600px;
            height: 140px;
            background: rgba(255,255,255,0.02);
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 20px rgba(0,242,255,0.1);
        }

        .road {
            position: absolute; bottom: 0; width: 100%; height: 40px;
            background: var(--road-color);
            border-top: 2px solid #555;
        }
        
        .road::after { /* เส้นถนน */
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
            background: repeating-linear-gradient(90deg, #fff, #fff 20px, transparent 20px, transparent 40px);
            opacity: 0.3;
        }

        /* ตัวหุ่นยนต์ */
        .robot-actor {
            position: absolute; bottom: 15px; left: 20px; /* จุดเริ่มต้น (ฐาน) */
            font-size: 3.5rem; color: var(--primary);
            transition: all 1.5s ease-in-out; /* ทำให้การเคลื่อนที่นุ่มนวล */
            text-shadow: 0 0 15px var(--primary);
            z-index: 2;
            transform: scaleX(-1); /* หันหน้าไปทางขวา (ถ้า icon เดิมหันซ้าย) */
        }
        
        /* กล่องบนหลังรถ */
        .cargo-actor {
            position: absolute; top: -15px; right: 5px;
            font-size: 1.5rem; color: #ffae00;
            display: none; /* ซ่อนก่อน */
            animation: bounce 0.8s infinite;
            text-shadow: 0 0 10px #ffae00;
        }

        /* ธงเป้าหมาย */
        .destination-flag {
            position: absolute; bottom: 40px; right: 30px;
            font-size: 2.5rem; color: var(--secondary);
            opacity: 0.2; transition: 0.3s;
        }

        @keyframes bounce { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-8px); } 
        }

        /* --- Header --- */
        header {
            width: 100%; max-width: 600px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        h1 { margin: 0; font-family: 'Orbitron'; font-size: 1.5rem; color: var(--primary); }
        .btn-logout {
            background: none; border: 1px solid #ff3333; color: #ff3333;
            padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        /* --- Dashboard --- */
        .dashboard {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            width: 100%; max-width: 600px; margin-bottom: 20px;
        }
        .card {
            background: var(--panel-bg); padding: 15px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .card i { font-size: 1.5rem; margin-bottom: 5px; color: #888; }
        .label { font-size: 0.8rem; opacity: 0.7; letter-spacing: 1px; }
        .value { font-size: 1.1rem; font-family: 'Orbitron'; font-weight: bold; margin-top: 5px; }

        .on { color: #00ff88; text-shadow: 0 0 5px #00ff88; }
        .off { color: #ff3333; text-shadow: 0 0 5px #ff3333; }
        .wait { color: #ffaa00; }

        /* --- Controls --- */
        .controls {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            width: 100%; max-width: 600px; margin-bottom: 20px;
        }
        .btn {
            background: linear-gradient(145deg, #1e2330, #161a25);
            border: 1px solid #444; color: white;
            padding: 20px 0; border-radius: 10px;
            font-family: 'Orbitron'; font-size: 0.9rem; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            transition: 0.2s;
        }
        .btn:hover { border-color: var(--primary); color: var(--primary); }
        .btn:active { transform: scale(0.95); }
        .btn-home { grid-column: span 3; background: linear-gradient(90deg, #cc0044, #ff0055); border: none; }

        /* --- Login Modal --- */
        #login-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box { text-align: center; width: 300px; background: #111; padding: 30px; border-radius: 15px; border: 1px solid var(--primary); }
        .inp { width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; text-align: center; box-sizing: border-box;}
        .btn-login { width: 100%; padding: 10px; background: var(--primary); border: none; font-weight: bold; cursor: pointer; margin-top: 10px; border-radius: 5px;}

    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="color:var(--primary); font-family:'Orbitron'">DELIBOT LOGIN</h2>
            <input type="text" id="user" class="inp" placeholder="Username">
            <input type="password" id="pass" class="inp" placeholder="Password">
            <button class="btn-login" onclick="login()">ACCESS SYSTEM</button>
            <p id="msg" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app" style="display:none; width:100%; flex-direction:column; align-items:center;">
        
        <header>
            <h1>DELI<span style="color:var(--text-main)">BOT</span></h1>
            <button class="btn-logout" onclick="logout()">LOGOUT</button>
        </header>

        <div class="scene-container">
            <div class="destination-flag" id="dest-flag"><i class="fas fa-map-marker-alt"></i></div>
            <div class="robot-actor" id="robot-actor">
                <i class="fas fa-robot"></i>
                <i class="fas fa-box cargo-actor" id="cargo-actor"></i>
            </div>
            <div class="road"></div>
        </div>

        <div class="dashboard">
            <div class="card">
                <i class="fas fa-wifi" id="icon-net"></i>
                <span class="label">NETWORK</span>
                <span class="value off" id="txt-net">OFFLINE</span>
            </div>
            <div class="card">
                <i class="fas fa-box" id="icon-cargo"></i>
                <span class="label">CARGO STATUS</span>
                <span class="value" id="txt-cargo" style="color:#888">EMPTY</span>
            </div>
            <div class="card">
                <i class="fas fa-robot" id="icon-bot"></i>
                <span class="label">ROBOT ACTION</span>
                <span class="value" id="txt-status">IDLE</span>
            </div>
            <div class="card">
                <i class="fas fa-ruler-horizontal"></i>
                <span class="label">DISTANCE</span>
                <span class="value" id="txt-dist">-- cm</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="send('room1')"><i class="fas fa-clinic-medical"></i>ROOM 1</button>
            <button class="btn" onclick="send('room2')"><i class="fas fa-flask"></i>ROOM 2</button>
            <button class="btn" onclick="send('room3')"><i class="fas fa-procedures"></i>ROOM 3</button>
            <button class="btn btn-home" onclick="send('return')"><i class="fas fa-home"></i>RETURN TO BASE</button>
        </div>

    </div>

    <script>
        // --- 1. CONFIGURATION (Stable & Secure) ---
        const MQTT_HOST = "broker.hivemq.com";
        const MQTT_PORT = 8884; // Secure Port for Web
        const TOPIC_CMD = "myrobot/command";
        const TOPIC_STATUS = "myrobot/status";
        
        const USER_SET = "admin";
        const PASS_SET = "1234";

        var client = null;

        // --- 2. LOGIN SYSTEM ---
        if(localStorage.getItem("isLogged") === "true") {
            showApp();
        }

        function login() {
            let u = document.getElementById("user").value;
            let p = document.getElementById("pass").value;
            if(u === USER_SET && p === PASS_SET) {
                localStorage.setItem("isLogged", "true");
                showApp();
            } else {
                document.getElementById("msg").innerText = "Wrong Password!";
                setTimeout(() => document.getElementById("msg").innerText = "", 2000);
            }
        }

        function logout() {
            if(client) { try { client.disconnect(); } catch(e){} }
            localStorage.removeItem("isLogged");
            location.reload();
        }

        function showApp() {
            document.getElementById("login-modal").style.display = "none";
            document.getElementById("app").style.display = "flex";
            initMQTT(); 
        }

        // --- 3. MQTT CONNECTION ---
        function initMQTT() {
            const clientID = "web_" + new Date().getTime();
            client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, clientID);

            client.onConnectionLost = onLost;
            client.onMessageArrived = onMessage;

            connect();
        }

        function connect() {
            document.getElementById("txt-net").innerText = "CONNECTING...";
            document.getElementById("txt-net").className = "value wait";

            client.connect({
                onSuccess: onConnect,
                onFailure: onFail,
                useSSL: true, // IMPORTANT
                timeout: 5,
                keepAliveInterval: 30
            });
        }

        function onConnect() {
            document.getElementById("txt-net").innerText = "ONLINE";
            document.getElementById("txt-net").className = "value on";
            document.getElementById("icon-net").className = "fas fa-wifi on";
            client.subscribe(TOPIC_STATUS);
        }

        function onFail(e) {
            console.log("Connect Failed", e);
            document.getElementById("txt-net").innerText = "RETRYING...";
            document.getElementById("txt-net").className = "value off";
            setTimeout(connect, 5000);
        }

        function onLost(e) {
            if(e.errorCode !== 0) {
                console.log("Connection Lost", e);
                document.getElementById("txt-net").innerText = "OFFLINE";
                document.getElementById("txt-net").className = "value off";
                document.getElementById("icon-net").className = "fas fa-wifi off";
                setTimeout(connect, 3000);
            }
        }

        // --- 4. SEND & RECEIVE ---
        function send(cmd) {
            if(client && client.isConnected()) {
                let payload = JSON.stringify({ "cmd": cmd });
                let message = new Paho.MQTT.Message(payload);
                message.destinationName = TOPIC_CMD;
                client.send(message);
                
                // Feedback UI
                document.getElementById("txt-status").innerText = "SENDING...";
            } else {
                alert("OFFLINE! Cannot send command.");
            }
        }

        function onMessage(msg) {
            try {
                const data = JSON.parse(msg.payloadString);
                
                // --- A. Update Cargo Logic ---
                const elCargo = document.getElementById("txt-cargo");
                const icCargo = document.getElementById("icon-cargo");
                const cargoActor = document.getElementById("cargo-actor"); // กล่องการ์ตูน

                if(data.cargo) {
                    elCargo.innerText = "LOADED"; elCargo.className = "value on";
                    icCargo.style.color = "#00ff88";
                    cargoActor.style.display = "block"; // โชว์กล่องบนรถ
                } else {
                    elCargo.innerText = "EMPTY"; elCargo.className = "value";
                    icCargo.style.color = "#888";
                    cargoActor.style.display = "none"; // ซ่อนกล่อง
                }

                // --- B. Update Animation & Status Logic ---
                const elStat = document.getElementById("txt-status");
                const icBot = document.getElementById("icon-bot");
                const robotActor = document.getElementById("robot-actor");
                const destFlag = document.getElementById("dest-flag");

                if(data.status === "delivering") {
                    elStat.innerText = "RUNNING (Room " + data.room + ")";
                    elStat.className = "value on";
                    icBot.className = "fas fa-robot on";
                    
                    // Animation: วิ่งไปทางขวา (80%)
                    robotActor.style.left = "80%";
                    robotActor.style.transform = "scaleX(1)"; // หันหน้าขวา
                    destFlag.style.opacity = "1"; // โชว์ธง

                } else { // idle หรืออื่นๆ
                    elStat.innerText = "IDLE / READY";
                    elStat.className = "value";
                    icBot.className = "fas fa-robot";

                    // Animation: กลับมาฐาน (20px)
                    robotActor.style.left = "20px";
                    robotActor.style.transform = "scaleX(-1)"; // หันหน้าซ้าย
                    destFlag.style.opacity = "0.2"; // ซ่อนธง
                }

                // --- C. Update Distance ---
                document.getElementById("txt-dist").innerText = data.distance + " cm";

            } catch(e) {
                console.log("JSON Error: " + e);
            }
        }
    </script>
</body>
</html>
